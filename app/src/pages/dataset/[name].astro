---
import Layout from "../../layouts/Layout.astro";
import FreshnessBadge from "../../components/FreshnessBadge.astro";
import { loadSnapshot, getDatasetBySlug } from "../../lib/snapshot";

export function getStaticPaths() {
  const snapshot = loadSnapshot();
  return snapshot.datasets.map((d) => ({
    params: { name: d.name },
  }));
}

const datasetName = Astro.params.name ?? "";
const snapshot = loadSnapshot();
const dataset = getDatasetBySlug(snapshot, datasetName);
if (!dataset) {
  return Astro.redirect(import.meta.env.BASE_URL);
}

const base = import.meta.env.BASE_URL;
---
<Layout title={`${dataset.title} — Observatorio`} description={dataset.title}>
  <h1>{dataset.title}</h1>
  <p class="dataset-slug">{dataset.name}</p>

  <dl class="info-list">
    <dt>Organización</dt>
    <dd><a href={`${base}org/${dataset.organization.name}`}>{dataset.organization.title}</a></dd>
    <dt>Última modificación</dt>
    <dd>{dataset.last_modified}</dd>
    <dt>Días desde modificación</dt>
    <dd>{dataset.days_since_modified}</dd>
    <dt>Freshness</dt>
    <dd><FreshnessBadge bucket={dataset.freshness_bucket} /></dd>
    <dt>Catálogo</dt>
    <dd><a href={dataset.catalog_url} target="_blank" rel="noopener noreferrer">Abrir en catálogo</a></dd>
  </dl>

  <h2>Recursos</h2>
  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Formato</th>
        <th>Última mod.</th>
        <th>URL</th>
        <th>HTTP</th>
        <th>OK</th>
        <th>Parse OK</th>
        <th>Bytes</th>
      </tr>
    </thead>
    <tbody>
      {dataset.resources.map((r) => [
        <tr>
          <td>{r.name}</td>
          <td>{r.format}</td>
          <td>{r.last_modified}</td>
          <td><a href={r.url} target="_blank" rel="noopener noreferrer">Enlace</a></td>
          <td>{r.check.http_status}</td>
          <td>{r.check.ok ? "Sí" : "No"}</td>
          <td>{r.check.parse_ok === null ? "—" : r.check.parse_ok ? "Sí" : "No"}</td>
          <td>{r.check.bytes_read.toLocaleString()}</td>
        </tr>,
        !r.check.ok && r.check.error ? (
          <tr>
            <td colspan="8" class="resource-error">{r.check.error}</td>
          </tr>
        ) : null,
      ])}
    </tbody>
  </table>
</Layout>

<style>
  .dataset-slug { color: #6c757d; font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1.5rem; }
  .info-list { display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 1.5rem; margin-bottom: 2rem; max-width: 600px; }
  .info-list dt { font-weight: 600; color: #495057; }
  .info-list dd { margin: 0; }
  h2 { margin-top: 2rem; }
  .resource-error { font-family: ui-monospace, monospace; }
</style>
